@model CustomerDashboardViewModel
 
@{
    ViewBag.Title = "Customer DashBoard";
    Layout = "_Layout2";
    var i = -1;
}

<!-- Customer Dashboard-->
<section class="serviceRequest">
    <div class="service-history">
        <div class="upcoming-service-details">
            <div class="container">
                <div id="upcoming-service-menu-table" class="d-flex">
                    <div class="container-menu">
                        <div class="navbar">
                            <ul id="upcoming-service-menu" class="nav flex-column">
                                <li class="nav-item active">
                                    <a class="nav-link">Dashboard</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" asp-action="CustomerServiceHistory" asp-controller="Customer">Service History</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Service Schedule</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Favourite Pros</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Invoices</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Notifications</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="container-details">
                        <div class="title d-flex justify-content-between">
                            <h3>Current Services Request</h3>
                            <button class="blue">Add New Services Request</button>
                        </div>
                        <div id="resscheduleMsg"></div>
                        <table id="Data" class="table mb-3">
                            <thead>
                                <tr>
                                    <th>Service ID</th>
                                    <th>Service Date</th>
                                    <th>Service Provider</th>
                                    <th>Payment</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.services != null)
                                {

                                    @foreach (var x in Model.services)
                                    {
                                        i += 1;
                                        @if(x.Status == null)
                                        {
                                            <tr id="service">
                                                <td>@x.ServiceId</td>
                                                <td class="table-item-2">
                                                    <span>
                                                        <img src="~/image/calendar2.png" alt="Sort">
                                                        <b>@String.Format("{0:dd/MM/yyyy}",x.ServiceStartDate)</b>
                                                    </span>
                                                    <br>
                                                    <span>
                                                        <img src="~/image/layer-14.png" alt="Sort">
                                                        @x.ServiceStartDate.ToString("HH:mm") -
                                                        @Model.serviceEnd[i].ToString("HH:mm")
                                                    </span>
                                                </td>

                                                <td class="rating">
                                                    @if (x.ServiceProviderId != null)
                                                    {
                                                        <div class="rating d-flex">
                                                            <img class="image4" src="~/image/cap.png" alt="Sort">
                                                            <div class="r-details d-flex flex-column">
                                                                <p>@Model.spName[i]</p>
                                                                <div class="star d-flex">
                                                                    <img src="~/image/star1.png" alt="">
                                                                    <img src="~/image/star1.png" alt="">
                                                                    <img src="~/image/star1.png" alt="">
                                                                    <img src="~/image/star1.png" alt="">
                                                                    <img src="~/image/star2.png" alt="">
                                                                    <p>4</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    }
                                                </td>
                                                <td>
                                                    <span id="Price"><p>@x.TotalCost &euro;</p></span>
                                                </td>
                                                <td class="button">
                                                        <a data-bs-toggle="modal" data-bs-target="#Reschedule">
                                                            <button class="blue" id="reschedule_@x.ServiceId">Reschedule</button>
                                                        </a>
                                                        <a data-bs-toggle="modal" data-bs-target="#cancel">
                                                            <button class="blue cancel" id="cancel_@x.ServiceId">Cancel</button>
                                                        </a>
                                                </td>
                                            </tr>
                                        }
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="Reschedule" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <h4 class="mb-4">Reschedule Service request</h4>
                <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close"><img
                        src="~/image/close.png"></button>
                <form class="mb-0">
                    <div class="row">
                        <label class="form-label">Select New Date & Time</label>
                        <div class="col-sm-6">
                            <div class="mb-3">
                                <input asp-for="@Model.serviceReschedule.serviceDate" class="form-control" placeholder="Date">
                                <span id="sDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                                <div class="dropdown">
                                    <select asp-for="@Model.serviceReschedule.serviceTime" class="button">
                                        <option value="8" selected>8:00</option>
                                        <option value="8.5">8:30</option>
                                        <option value="9">9:00</option>
                                        <option value="9.5">9:30</option>
                                        <option value="10">10:00</option>
                                        <option value="10.5">10:30</option>
                                        <option value="11">11:00</option>
                                        <option value="11.5">11:30</option>
                                        <option value="12">12:00</option>
                                        <option value="12.5">12:30</option>
                                        <option value="13">13:00</option>
                                        <option value="13.5">13:30</option>
                                        <option value="14">14:00</option>
                                        <option value="14.5">14:30</option>
                                        <option value="15">15:00</option>
                                        <option value="15.5">15:30</option>
                                        <option value="16">16:00</option>
                                        <option value="16.5">16:30</option>
                                        <option value="17">17:00</option>
                                        <option value="17.5">17:30</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="updateTime" class="update text-center">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cancel" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <h4 class="mb-4">Cancel Service request</h4>
                    <button type="button" class="close-btn" data-bs-dismiss="modal" aria-label="Close"><img
                            src="~/image/close.png"></button>
                    <form class="mb-0">
                        <label class="form-label">Why you want to cancel the service request?</label>
                        <div class="mb-3">
                            <textarea asp-for="@Model.cancelService.Reason" type="text" class="form-control" rows="4"></textarea>
                        </div>
                        <button type="button" id="Cancel" class="update text-center">Cancel Now</button>
                    </form>
                </div>
            </div>

        </div>
    </div>

@section Scripts{
    <script>
        $(document).ready(function(){
            
            let sId = 0;
            let cId = 0;
            $("[id^='reschedule_']").click(function(){
                var a = $(this).prop('id');
                console.log(a);
                sId = a.split('_')[1];
            });

            $("[id^='cancel_']").click(function(){
                var a = $(this).prop('id');
                console.log(a);
                cId = a.split('_')[1];
            });

            $('#updateTime').click(function(){
                let rescheduleModel ={
                    serviceDate: $('#@Html.IdFor(m => m.serviceReschedule.serviceDate)').val(),
                    serviceTime: parseInt($('#@Html.IdFor(m => m.serviceReschedule.serviceTime)').val()),
                    ServiceId: parseInt(sId)
                }
                console.log(rescheduleModel);
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("ServiceReschedule","Customer")',
                    data: rescheduleModel,
                    dataType: 'JSON',
                    success: function (response) {
                        if(response.success)
                        {
                            $('#Reschedule').modal('hide');                            
                            location.reload(true);
                            $('#resscheduleMsg').html(`<div class="alert alert-primary alert-dismissible fade show" role="alert">
                                    Rescheduled your service successfully
                                    <button type="submit" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>`);
                        }
                        if(!response.success)
                        {
                            $('#Reschedule').modal('hide');
                            $('#resscheduleMsg').html(`<div class="alert alert-danger alert-dismissible fade show" role="alert">
                            Rescheduled isn't possible. Sp is not available
                            <button type="submit" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>`);
                        }
                    }
                });
            });

            $('#Cancel').click(function(){
                let model2 = {
                    ServiceId : cId,
                    Reason : $('#@Html.IdFor(m => m.cancelService.Reason)').val()
                }
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("ServiceCancel","Customer")',
                    data: model2,
                    dataType: 'JSON',
                    success: function (response) {
                        if(response.success)
                        {
                            $('#cancel').modal('hide');
                            location.reload(true);
                        }
                    }
                });
            });

        });
    </script>
}

